# Метрики, вычисляемые в проекте Analyzer

Этот документ описывает все ключевые метрики, которые генерируются скриптом `run_all_ultra.py` для оценки арбитражных возможностей.

## 1. Метрики среднего реверсирования (Mean Reversion)

Эти метрики оценивают, как часто и насколько сильно цена отклоняется от своего среднего значения и возвращается обратно.

### 1.1. `zero_crossings_per_minute`
- **Описание:** Частота, с которой отклонение (`deviation`) пересекает нулевой уровень в минуту. Это ключевой показатель интенсивности среднего реверсирования. Чем выше значение, тем чаще цена колеблется вокруг точки равновесия.
- **Вычисление:** [`run_all_ultra.py:265`](analyzer/run_all_ultra.py:265)
- **Логика:**
  ```python
  zero_crossings = # количество смен знака в deviation
  duration_hours = # общая длительность данных в часах
  zero_crossings_per_minute = (zero_crossings / duration_hours) / 60
  ```

### 1.2. `deviation_asymmetry`
- **Описание:** Среднее значение отклонения (`deviation`). Показывает, есть ли у спреда постоянный уклон в одну сторону.
  - Значение близкое к `0` указывает на симметричные колебания вокруг ценового паритета.
  - Значительное положительное или отрицательное значение (`> 0.2`) указывает на постоянное смещение, что может снижать вероятность возврата к нулю.
- **Вычисление:** [`run_all_ultra.py:245`](analyzer/run_all_ultra.py:245)
- **Логика:**
  ```python
  asymmetry = mean_deviation_pct
  ```

## 2. Метрики торговых возможностей (Opportunity Metrics)

Эти метрики подсчитывают количество и характеристики потенциально прибыльных торговых циклов.

### 2.1. `opportunity_cycles_*`
- **Описание:** Количество **полных** торговых циклов для заданного порога (например, `030bp` для 0.3%). Полный цикл — это ситуация, когда отклонение превышает порог, а затем возвращается в "нейтральную зону" (определяется `ZERO_THRESHOLD`). Это гарантирует, что мы считаем только те возможности, где позицию можно было бы открыть и закрыть с возвратом к безубытку.
- **Вычисление:** [`run_all_ultra.py:321-332`](analyzer/run_all_ultra.py:321-332) с использованием функции `count_complete_cycles`.
- **Логика:**
  ```python
  # Псевдокод для count_complete_cycles
  was_above = False
  for deviation_value in deviations:
      if abs(deviation_value) > threshold:
          was_above = True
      elif abs(deviation_value) < ZERO_THRESHOLD and was_above:
          cycles += 1
          was_above = False
  ```

### 2.2. `cycles_*_per_hour`
- **Описание:** Нормализованное количество полных циклов в час. Позволяет сравнивать инструменты с разной длительностью исторических данных.
- **Вычисление:** [`run_all_ultra.py:362`](analyzer/run_all_ultra.py:362)
- **Логика:**
  ```python
  cycles_per_hour = opportunity_cycles / duration_hours
  ```

### 2.3. `pct_time_above_*`
- **Описание:** Процент времени, в течение которого абсолютное значение отклонения находилось выше заданного порога. Показывает, как долго сохраняются торговые возможности.
- **Вычисление:** [`run_all_ultra.py:335-339`](analyzer/run_all_ultra.py:335-339)
- **Логика:**
  ```python
  pct_time_above = (pl.col('above_threshold_flag').mean() * 100)
  ```

### 2.4. `avg_cycle_duration_*_sec`
- **Описание:** Средняя продолжительность времени (в секундах), в течение которого отклонение находилось выше порога в рамках одного полного цикла.
- **Вычисление:** [`run_all_ultra.py:349`](analyzer/run_all_ultra.py:349)
- **Логика:**
  ```python
  total_time_above_threshold_sec = duration_hours * (pct_time_above / 100) * 3600
  avg_duration_sec = total_time_above_threshold_sec / opportunity_cycles
  ```

## 3. Метрики риска и состояния

### 3.1. `pattern_break_*`
- **Описание:** Логический флаг, который становится `True`, если на момент окончания данных абсолютное значение отклонения все еще находится выше порога. Это может указывать на "слом паттерна" — ситуацию, когда среднее реверсирование не произошло, и цена ушла в новом направлении.
- **Вычисление:** [`run_all_ultra.py:356`](analyzer/run_all_ultra.py:356)
- **Логика:**
  ```python
  last_deviation = abs(joined['deviation'][-1])
  pattern_break = last_deviation > threshold
  ```

### 3.2. `max_deviation_pct` / `min_deviation_pct`
- **Описание:** Максимальное и минимальное зафиксированное отклонение в процентах. Показывает экстремумы, достигнутые спредом.
- **Вычисление:** [`run_all_ultra.py:236-237`](analyzer/run_all_ultra.py:236-237)
- **Логика:**
  ```python
  max_deviation_pct = float(joined['deviation'].max())
  min_deviation_pct = float(joined['deviation'].min())
  ```

## 4. Общие метрики

- **`data_points`**: Общее количество точек данных после синхронизации (`join_asof`).
- **`duration_hours`**: Общая продолжительность анализируемого периода в часах.
