graph TD
    subgraph "1. Initialization"
        A[Start Application] --> B{ConfigureServices};
        B --> C[Start IHostedServices];
    end

    subgraph "2. Orchestration (OrchestrationService)"
        C --> D{StartAsync};
        D --> E[Get Exchange Configs];
        E --> F{Loop through Exchanges};
        F --> G(ProcessExchange per exchange);
    end

    subgraph "3. Exchange Processing (ProcessExchange)"
        G --> H[Get Symbols & Tickers];
        H --> I{Filter Symbols by Volume};
        I --> J[SubscribeToTickersAsync];
        J --> K[SubscribeToTradesAsync];
    end

    subgraph "4. Real-time Data Handling (Callback)"
        J --> L{On SpreadData Received};
        K --> L;
        L --> M[Normalize Symbol];
        M --> N[Calculate Spread%];
        N --> O(HOT PATH: Broadcast to WebSocket);
        N --> P(COLD PATH: Write to Channels);
    end

    subgraph "5. Data Consumption (Parallel)"
        P -- "RawDataChannel" --> Q[DataCollectorService];
        Q --> R[ParquetDataWriter];
        R --> S[Save to .parquet file];

        P -- "RollingWindowChannel" --> T[RollingWindowService];
        T --> U[Real-time Analysis];
    end

    style O fill:#ff9999,stroke:#333,stroke-width:2px
    style P fill:#99ccff,stroke:#333,stroke-width:2px
