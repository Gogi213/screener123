<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEXC Trade Screener - Table View</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        /* SPRINT-10: Table-specific styles using CSS variables from styles.css */
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-app);
            color: var(--text-primary);
        }

        .header {
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-subtle);
            padding-bottom: 10px;
        }

        .tab {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 6px;
            font-size: 13px;
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.2s ease;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--border-hover);
        }

        .tab.active {
            background: var(--accent-dim);
            border-color: var(--accent);
            color: var(--accent);
            font-weight: 500;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Status */
        #status {
            margin-bottom: 15px;
            padding: 10px 15px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            font-size: 13px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #status.connected {
            border-color: var(--success);
            color: var(--success);
        }

        #status.connecting {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Table styles */
        .table-container {
            overflow-x: auto;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.03), transparent);
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer;
            user-select: none;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        th:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        th.sortable::after {
            content: ' ‚áÖ';
            opacity: 0.3;
        }

        th.sorted-asc::after {
            content: ' ‚Üë';
            opacity: 1;
            color: var(--accent);
        }

        th.sorted-desc::after {
            content: ' ‚Üì';
            opacity: 1;
            color: var(--accent);
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .symbol {
            font-weight: 600;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            transition: color 0.2s;
        }

        .symbol:hover {
            color: var(--accent);
        }

        .positive {
            color: var(--success);
        }

        .negative {
            color: var(--danger);
        }

        .volume {
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        .trades {
            color: var(--accent);
            font-weight: 500;
            font-family: 'JetBrains Mono', monospace;
        }

        .price {
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        .natr {
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }
        .natr.high { color: var(--accent); }  /* NATR > 5% */

        /* Charts view placeholder */
        #chartsContainer {
            padding: 40px;
            text-align: center;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
        }

        #chartsContainer h2 {
            color: var(--accent);
            margin-bottom: 10px;
        }

        #chartsContainer p {
            color: var(--text-secondary);
        }

        #chartsContainer a {
            color: var(--accent);
            text-decoration: none;
        }

        #chartsContainer a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="header">
        <div id="status" class="connecting">‚è≥ Connecting...</div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('table')">üìä Table</button>
            <button class="tab" onclick="switchTab('charts')">üìà Charts</button>
        </div>
    </div>

    <!-- Table View (default) -->
    <div id="tableView" class="view active">
        <div class="table-container">
            <table id="symbolsTable">
                <thead>
                    <tr>
                        <th class="sortable" data-column="symbol">Symbol</th>
                        <th class="sortable" data-column="trades5m">Trades 5m</th>
                        <th class="sortable" data-column="volume24h">24h Volume</th>
                        <th class="sortable" data-column="change4h">4h Change</th>
                        <th class="sortable" data-column="natr">NATR %</th>
                        <th class="sortable" data-column="largePrints">Large Prints</th>
                        <th class="sortable" data-column="price">Price</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Rows will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Charts View (lazy loaded) -->
    <div id="chartsView" class="view">
        <div id="chartsContainer">
            <h2>Charts View</h2>
            <p>This will load the full chart grid from screener.js</p>
            <p style="margin-top: 20px;">
                <a href="/index.html">Open original screener ‚Üí</a>
            </p>
        </div>
    </div>

    <script>
        // Global state
        let allSymbols = [];
        let currentSort = { column: 'trades5m', direction: 'desc' };
        let chartsLoaded = false;
        let ws = null;

        // WebSocket connection
        function initWebSocket() {
            ws = new WebSocket(`ws://${window.location.hostname}:8181`);

            ws.onopen = () => {
                const statusEl = document.getElementById('status');
                statusEl.textContent = '‚úÖ Connected';
                statusEl.className = 'connected';
            };

            ws.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);

                    if (msg.type === 'all_symbols_scored') {
                        // Update table data
                        allSymbols = msg.symbols.map(s => ({
                            symbol: s.symbol,
                            trades5m: s.trades5m || 0,
                            volume24h: s.volume24h || 0,
                            change4h: s.priceChangePercent4h || 0,
                            natr: s.natr || 0,
                            largePrintCount5m: s.largePrintCount5m || 0,
                            lastLargePrintRatio: s.lastLargePrintRatio || 0,
                            price: s.lastPrice || 0,
                            // Keep all data for potential charts
                            ...s
                        }));

                        sortAndRenderTable();
                    }
                } catch (err) {
                    console.error('Parse error:', err);
                }
            };

            ws.onclose = () => {
                const statusEl = document.getElementById('status');
                statusEl.textContent = '‚ö†Ô∏è Disconnected. Reconnecting...';
                statusEl.className = 'connecting';
                setTimeout(initWebSocket, 2000);
            };
        }

        // Sort and render table
        function sortAndRenderTable() {
            const sorted = [...allSymbols].sort((a, b) => {
                let column = currentSort.column;

                // Map column names to actual data fields
                if (column === 'largePrints') column = 'largePrintCount5m';

                let aVal = a[column];
                let bVal = b[column];

                // String comparison for symbol
                if (currentSort.column === 'symbol') {
                    return currentSort.direction === 'asc'
                        ? aVal.localeCompare(bVal)
                        : bVal.localeCompare(aVal);
                }

                // Numeric comparison
                return currentSort.direction === 'asc'
                    ? aVal - bVal
                    : bVal - aVal;
            });

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = sorted.map(s => `
                <tr>
                    <td class="symbol" onclick="copySymbol('${s.symbol}')">${s.symbol}</td>
                    <td class="trades">${s.trades5m}</td>
                    <td class="volume">${formatVolume(s.volume24h)}</td>
                    <td class="${s.change4h >= 0 ? 'positive' : 'negative'}">
                        ${s.change4h >= 0 ? '+' : ''}${s.change4h.toFixed(2)}%
                    </td>
                    <td class="natr">${s.natr > 0 ? s.natr.toFixed(2) + '%' : '---'}</td>
                    <td class="large-prints ${s.largePrintCount5m > 0 ? 'active' : ''}">
                        ${s.largePrintCount5m > 0 ? '‚ö° ' : ''}${s.largePrintCount5m}${s.largePrintCount5m > 0 ? ` (${s.lastLargePrintRatio.toFixed(1)}x)` : ''}
                    </td>
                    <td class="price">${formatPrice(s.price)}</td>
                </tr>
            `).join('');

            // Update header indicators
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
                if (th.dataset.column === currentSort.column) {
                    th.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
                }
            });
        }

        // Format volume with K/M suffix
        function formatVolume(vol) {
            if (vol >= 1000000) return `$${(vol / 1000000).toFixed(2)}M`;
            if (vol >= 1000) return `$${(vol / 1000).toFixed(2)}K`;
            return `$${vol.toFixed(2)}`;
        }

        // Format price based on value
        function formatPrice(price) {
            if (!price || price <= 0) return '---';
            if (price >= 1) return price.toFixed(2);
            if (price >= 0.01) return price.toFixed(4);
            if (price >= 0.0001) return price.toFixed(6);
            return price.toFixed(8).replace(/\.?0+$/, '');
        }

        // Copy symbol to clipboard
        async function copySymbol(symbol) {
            try {
                await navigator.clipboard.writeText(symbol);
                // Visual feedback
                const symbolEls = document.querySelectorAll('.symbol');
                symbolEls.forEach(el => {
                    if (el.textContent === symbol) {
                        const originalColor = el.style.color;
                        el.style.color = 'var(--success)';
                        setTimeout(() => { el.style.color = originalColor; }, 300);
                    }
                });
            } catch (err) {
                console.error('Failed to copy:', err);
            }
        }

        // Handle column click for sorting
        document.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const column = th.dataset.column;
                if (currentSort.column === column) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = column;
                    currentSort.direction = 'desc';
                }
                sortAndRenderTable();
            });
        });

        // Switch between tabs
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Update views
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            if (tabName === 'table') {
                document.getElementById('tableView').classList.add('active');
            } else {
                document.getElementById('chartsView').classList.add('active');
                // Lazy load charts only when user first switches to charts tab
                if (!chartsLoaded) {
                    chartsLoaded = true;
                }
            }
        }

        // Initialize
        initWebSocket();
    </script>
</body>

</html>