<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEXC Trade Screener - Table View</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        /* SPRINT-10: Table-specific styles */
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0e27;
            color: #e0e0e0;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #1e2a47;
            padding-bottom: 10px;
        }

        .tab {
            padding: 10px 20px;
            background: #1e2a47;
            border: none;
            color: #8b9dc3;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            font-size: 14px;
            transition: all 0.2s;
        }

        .tab.active {
            background: #2a3f5f;
            color: #fff;
            font-weight: bold;
        }

        .tab:hover {
            background: #2a3f5f;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Table styles */
        .table-container {
            overflow-x: auto;
            background: #141b2d;
            border-radius: 8px;
            padding: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            background: #1e2a47;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: #8b9dc3;
            border-bottom: 2px solid #2a3f5f;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: #2a3f5f;
        }

        th.sortable::after {
            content: ' â‡…';
            opacity: 0.3;
        }

        th.sorted-asc::after {
            content: ' â†‘';
            opacity: 1;
        }

        th.sorted-desc::after {
            content: ' â†“';
            opacity: 1;
        }

        td {
            padding: 10px 15px;
            border-bottom: 1px solid #1e2a47;
        }

        tr:hover td {
            background: #1e2a47;
        }

        .symbol {
            font-weight: 600;
            color: #fff;
            font-family: 'JetBrains Mono', monospace;
        }

        .positive {
            color: #10b981;
        }

        .negative {
            color: #ef4444;
        }

        .volume {
            color: #8b9dc3;
        }

        .trades {
            color: #60a5fa;
            font-weight: 500;
        }

        #status {
            margin-bottom: 15px;
            padding: 10px 15px;
            background: #1e2a47;
            border-radius: 5px;
            font-size: 14px;
        }

        /* Charts view (lazy loaded) */
        #chartsContainer {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
        }
    </style>
</head>
<body>
    <div id="status">Connecting...</div>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('table')">ðŸ“Š Table</button>
        <button class="tab" onclick="switchTab('charts')">ðŸ“ˆ Charts</button>
    </div>

    <!-- Table View (default) -->
    <div id="tableView" class="view active">
        <div class="table-container">
            <table id="symbolsTable">
                <thead>
                    <tr>
                        <th class="sortable" data-column="symbol">Symbol</th>
                        <th class="sortable" data-column="trades5m">Trades 5m</th>
                        <th class="sortable" data-column="volume24h">24h Volume</th>
                        <th class="sortable" data-column="change24h">24h Change %</th>
                        <th class="sortable" data-column="price">Price</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Rows will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Charts View (lazy loaded) -->
    <div id="chartsView" class="view">
        <div id="chartsContainer">
            <!-- Charts will be loaded here when user switches to this tab -->
        </div>
    </div>

    <script>
        // Global state
        let allSymbols = [];
        let currentSort = { column: 'trades5m', direction: 'desc' };
        let chartsLoaded = false;
        let ws = null;

        // WebSocket connection
        function initWebSocket() {
            ws = new WebSocket('ws://localhost:8181');

            ws.onopen = () => {
                document.getElementById('status').textContent = 'Connected âœ…';
                document.getElementById('status').style.background = '#10b981';
                document.getElementById('status').style.color = '#fff';
            };

            ws.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);

                    if (msg.type === 'all_symbols_scored') {
                        // Update table data
                        allSymbols = msg.symbols.map(s => ({
                            symbol: s.symbol,
                            trades5m: s.trades5m || 0,
                            volume24h: s.volume24h || 0,
                            change24h: s.priceChangePercent24h || 0,
                            price: s.lastPrice || 0,
                            // Keep all data for charts
                            ...s
                        }));

                        sortAndRenderTable();
                    }
                } catch (err) {
                    console.error('Parse error:', err);
                }
            };

            ws.onclose = () => {
                document.getElementById('status').textContent = 'Disconnected. Reconnecting...';
                document.getElementById('status').style.background = '#ef4444';
                setTimeout(initWebSocket, 2000);
            };
        }

        // Sort and render table
        function sortAndRenderTable() {
            const sorted = [...allSymbols].sort((a, b) => {
                let aVal = a[currentSort.column];
                let bVal = b[currentSort.column];

                // String comparison for symbol
                if (currentSort.column === 'symbol') {
                    return currentSort.direction === 'asc'
                        ? aVal.localeCompare(bVal)
                        : bVal.localeCompare(aVal);
                }

                // Numeric comparison
                return currentSort.direction === 'asc'
                    ? aVal - bVal
                    : bVal - aVal;
            });

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = sorted.map(s => `
                <tr>
                    <td class="symbol">${s.symbol}</td>
                    <td class="trades">${s.trades5m}</td>
                    <td class="volume">${formatVolume(s.volume24h)}</td>
                    <td class="${s.change24h >= 0 ? 'positive' : 'negative'}">
                        ${s.change24h >= 0 ? '+' : ''}${s.change24h.toFixed(2)}%
                    </td>
                    <td>${s.price.toFixed(8)}</td>
                </tr>
            `).join('');

            // Update header indicators
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
                if (th.dataset.column === currentSort.column) {
                    th.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
                }
            });
        }

        // Format volume
        function formatVolume(vol) {
            if (vol >= 1000000) return `$${(vol / 1000000).toFixed(2)}M`;
            if (vol >= 1000) return `$${(vol / 1000).toFixed(2)}K`;
            return `$${vol.toFixed(2)}`;
        }

        // Handle column click for sorting
        document.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const column = th.dataset.column;
                if (currentSort.column === column) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = column;
                    currentSort.direction = 'desc';
                }
                sortAndRenderTable();
            });
        });

        // Switch between tabs
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Update views
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            if (tabName === 'table') {
                document.getElementById('tableView').classList.add('active');
            } else {
                document.getElementById('chartsView').classList.add('active');
                // Lazy load charts only when user first switches to charts tab
                if (!chartsLoaded) {
                    loadCharts();
                    chartsLoaded = true;
                }
            }
        }

        // Lazy load charts
        function loadCharts() {
            document.getElementById('chartsContainer').innerHTML = '<p style="color: #8b9dc3; padding: 20px;">Loading charts...</p>';

            // Load the original screener.js logic here
            // For now, just show a placeholder
            setTimeout(() => {
                const container = document.getElementById('chartsContainer');
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; background: #1e2a47; border-radius: 8px;">
                        <h2 style="color: #60a5fa; margin-bottom: 10px;">Charts Loading</h2>
                        <p style="color: #8b9dc3;">This will load the full chart grid from screener.js</p>
                        <p style="color: #8b9dc3; margin-top: 20px;">
                            <a href="/index.html" style="color: #60a5fa;">Open original screener â†’</a>
                        </p>
                    </div>
                `;
            }, 500);
        }

        // Initialize
        initWebSocket();
    </script>
</body>
</html>
